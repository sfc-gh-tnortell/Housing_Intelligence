# ================================================================
# HOUSING INTELLIGENCE SEMANTIC MODEL
# ================================================================
# This YAML file defines the semantic model for Cortex Analyst
# to understand the housing sales data structure and relationships

semantic_model:
  name: "housing_sales_model"
  description: "Semantic model for housing sales analysis including customer demographics, property characteristics, and transaction details"
  
  # Define the base tables
  tables:
    - name: "customers"
      description: "Customer information including demographics and buying preferences"
      base_table: "HOUSING_INTELLIGENCE.CORE.CUSTOMERS"
      primary_key: "CUSTOMER_ID"
      
    - name: "house_characteristics" 
      description: "Detailed property information including location, size, features, and pricing"
      base_table: "HOUSING_INTELLIGENCE.CORE.HOUSE_CHARACTERISTICS"
      primary_key: "HOUSE_ID"
      
    - name: "house_sales"
      description: "Transaction records linking customers to properties with sale details"
      base_table: "HOUSING_INTELLIGENCE.CORE.HOUSE_SALES"
      primary_key: "SALE_ID"

  # Define relationships between tables
  relationships:
    - name: "customer_to_sales"
      type: "one_to_many"
      from_table: "customers"
      from_column: "CUSTOMER_ID"
      to_table: "house_sales" 
      to_column: "CUSTOMER_ID"
      
    - name: "house_to_sales"
      type: "one_to_many"
      from_table: "house_characteristics"
      from_column: "HOUSE_ID"
      to_table: "house_sales"
      to_column: "HOUSE_ID"

  # Define dimensions for analysis
  dimensions:
    # Customer dimensions
    - name: "customer_demographics"
      description: "Customer demographic information"
      table: "customers"
      columns:
        - name: "customer_id"
          description: "Unique customer identifier"
        - name: "age_group"
          description: "Customer age category"
          expr: "CASE 
                   WHEN DATEDIFF('year', date_of_birth, CURRENT_DATE()) < 30 THEN 'Under 30'
                   WHEN DATEDIFF('year', date_of_birth, CURRENT_DATE()) < 40 THEN '30-39'
                   WHEN DATEDIFF('year', date_of_birth, CURRENT_DATE()) < 50 THEN '40-49'
                   WHEN DATEDIFF('year', date_of_birth, CURRENT_DATE()) < 60 THEN '50-59'
                   ELSE '60+' 
                 END"
        - name: "income_bracket"
          description: "Customer income level category"
          expr: "CASE 
                   WHEN annual_income < 50000 THEN 'Under $50K'
                   WHEN annual_income < 75000 THEN '$50K-$75K'
                   WHEN annual_income < 100000 THEN '$75K-$100K'
                   WHEN annual_income < 150000 THEN '$100K-$150K'
                   ELSE '$150K+' 
                 END"
        - name: "credit_rating"
          description: "Customer credit score category"
          expr: "CASE 
                   WHEN credit_score < 600 THEN 'Poor'
                   WHEN credit_score < 700 THEN 'Fair'
                   WHEN credit_score < 750 THEN 'Good'
                   WHEN credit_score < 800 THEN 'Very Good'
                   ELSE 'Excellent' 
                 END"
        - name: "marital_status"
          description: "Customer marital status"
        - name: "employment_status"
          description: "Customer employment type"
        - name: "family_size"
          description: "Number of family members"

    # Property dimensions
    - name: "property_details"
      description: "Property characteristics and features"
      table: "house_characteristics"
      columns:
        - name: "house_id"
          description: "Unique property identifier"
        - name: "location"
          description: "Property location details"
        - name: "city"
          description: "City where property is located"
        - name: "state"
          description: "State where property is located"
        - name: "neighborhood"
          description: "Neighborhood name"
        - name: "property_type"
          description: "Type of property (Single Family, Condo, Townhouse)"
        - name: "size_category"
          description: "Property size classification"
          expr: "CASE 
                   WHEN square_footage < 1200 THEN 'Small (Under 1,200 sq ft)'
                   WHEN square_footage < 1800 THEN 'Medium (1,200-1,800 sq ft)'
                   WHEN square_footage < 2500 THEN 'Large (1,800-2,500 sq ft)'
                   ELSE 'Very Large (2,500+ sq ft)' 
                 END"
        - name: "bedrooms"
          description: "Number of bedrooms"
        - name: "bathrooms"
          description: "Number of bathrooms"
        - name: "year_built"
          description: "Year the property was built"
        - name: "age_category"
          description: "Property age classification"
          expr: "CASE 
                   WHEN year_built >= 2020 THEN 'New (2020+)'
                   WHEN year_built >= 2010 THEN 'Recent (2010-2019)'
                   WHEN year_built >= 2000 THEN 'Modern (2000-2009)'
                   WHEN year_built >= 1990 THEN 'Established (1990-1999)'
                   ELSE 'Vintage (Pre-1990)' 
                 END"
        - name: "has_premium_features"
          description: "Property has premium amenities"
          expr: "CASE WHEN (has_pool = TRUE OR has_fireplace = TRUE OR garage_spaces >= 3) THEN 'Yes' ELSE 'No' END"

    # Geographic dimensions
    - name: "location_metrics"
      description: "Location-based property metrics"
      table: "house_characteristics"
      columns:
        - name: "walk_score_category"
          description: "Walkability rating category"
          expr: "CASE 
                   WHEN walk_score >= 90 THEN 'Walker\'s Paradise'
                   WHEN walk_score >= 70 THEN 'Very Walkable'
                   WHEN walk_score >= 50 THEN 'Somewhat Walkable'
                   ELSE 'Car-Dependent' 
                 END"
        - name: "crime_rate"
          description: "Area crime level"
        - name: "school_district"
          description: "School district name"

    # Time dimensions
    - name: "time_periods"
      description: "Time-based analysis dimensions"
      table: "house_sales"
      columns:
        - name: "sale_year"
          description: "Year of sale"
          expr: "YEAR(sale_date)"
        - name: "sale_month"
          description: "Month of sale"
          expr: "MONTH(sale_date)"
        - name: "sale_quarter"
          description: "Quarter of sale"
          expr: "QUARTER(sale_date)"
        - name: "market_timing"
          description: "How quickly property sold"
          expr: "CASE 
                   WHEN days_on_market <= 14 THEN 'Very Fast (â‰¤2 weeks)'
                   WHEN days_on_market <= 30 THEN 'Fast (2-4 weeks)'
                   WHEN days_on_market <= 60 THEN 'Normal (1-2 months)'
                   ELSE 'Slow (2+ months)' 
                 END"

  # Define measures for analysis
  measures:
    # Price measures
    - name: "average_sale_price"
      description: "Average sale price of properties"
      agg: "AVG"
      expr: "house_sales.sale_price"
      
    - name: "median_sale_price"
      description: "Median sale price of properties"
      agg: "MEDIAN"
      expr: "house_sales.sale_price"
      
    - name: "total_sales_volume"
      description: "Total dollar volume of sales"
      agg: "SUM"
      expr: "house_sales.sale_price"
      
    - name: "price_per_sqft"
      description: "Average price per square foot"
      agg: "AVG"
      expr: "house_sales.sale_price / house_characteristics.square_footage"
      
    # Market measures
    - name: "average_days_on_market"
      description: "Average number of days properties stayed on market"
      agg: "AVG"
      expr: "house_sales.days_on_market"
      
    - name: "price_reduction_percentage"
      description: "Average percentage reduction from listing to sale price"
      agg: "AVG"
      expr: "(house_sales.listing_price - house_sales.sale_price) / house_sales.listing_price * 100"
      
    # Count measures
    - name: "number_of_sales"
      description: "Total number of property sales"
      agg: "COUNT"
      expr: "house_sales.sale_id"
      
    - name: "number_of_customers"
      description: "Total number of unique customers"
      agg: "COUNT_DISTINCT"
      expr: "house_sales.customer_id"
      
    # Financial measures
    - name: "average_loan_amount"
      description: "Average loan amount for financed purchases"
      agg: "AVG"
      expr: "house_sales.loan_amount"
      
    - name: "average_down_payment"
      description: "Average down payment amount"
      agg: "AVG"
      expr: "house_sales.down_payment_amount"
      
    - name: "total_commission"
      description: "Total commission paid to agents"
      agg: "SUM"
      expr: "house_sales.commission_amount"

  # Define filters for common queries
  filters:
    - name: "sale_date_range"
      description: "Filter sales by date range"
      expr: "house_sales.sale_date"
      
    - name: "price_range"
      description: "Filter properties by sale price range"
      expr: "house_sales.sale_price"
      
    - name: "location_filter"
      description: "Filter by city or state"
      expr: "house_characteristics.city"
      
    - name: "property_type_filter"
      description: "Filter by property type"
      expr: "house_characteristics.property_type"
      
    - name: "financing_type_filter"
      description: "Filter by financing method"
      expr: "house_sales.financing_type"