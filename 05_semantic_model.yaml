# ================================================================
# HOUSING INTELLIGENCE SEMANTIC MODEL FOR CORTEX ANALYST
# ================================================================
# This YAML file defines the semantic model for Cortex Analyst
# to understand the housing sales data structure, relationships, and business context
# Supporting both structured data analysis and document search integration

semantic_model:
  name: "housing_sales_intelligence_model"
  description: "Comprehensive semantic model for housing sales analysis including customer demographics, property characteristics, transaction details, and document relationships"
  
  # Define the base tables
  tables:
    - name: "customers"
      description: "Customer information including demographics, financial profile, and buying preferences"
      base_table: "HOUSING_INTELLIGENCE.CORE.CUSTOMERS"
      primary_key: "CUSTOMER_ID"
      
    - name: "house_characteristics" 
      description: "Detailed property information including location, size, features, amenities, and pricing"
      base_table: "HOUSING_INTELLIGENCE.CORE.HOUSE_CHARACTERISTICS"
      primary_key: "HOUSE_ID"
      
    - name: "house_sales"
      description: "Transaction records linking customers to properties with comprehensive sale details and financing information"
      base_table: "HOUSING_INTELLIGENCE.CORE.HOUSE_SALES"
      primary_key: "SALE_ID"
      
    - name: "purchase_agreements"
      description: "Legal document metadata for purchase agreements stored as PDFs with contract details"
      base_table: "HOUSING_INTELLIGENCE.CORE.PURCHASE_AGREEMENTS"
      primary_key: "AGREEMENT_ID"

  # Define relationships between tables
  relationships:
    - name: "customer_to_sales"
      type: "one_to_many"
      from_table: "customers"
      from_column: "CUSTOMER_ID"
      to_table: "house_sales" 
      to_column: "CUSTOMER_ID"
      
    - name: "house_to_sales"
      type: "one_to_many"
      from_table: "house_characteristics"
      from_column: "HOUSE_ID"
      to_table: "house_sales"
      to_column: "HOUSE_ID"
      
    - name: "sales_to_agreements"
      type: "one_to_one"
      from_table: "house_sales"
      from_column: "SALE_ID"
      to_table: "purchase_agreements"
      to_column: "SALE_ID"

  # Define dimensions for analysis
  dimensions:
    # Customer dimensions
    - name: "customer_demographics"
      description: "Customer demographic and financial segmentation"
      table: "customers"
      columns:
        - name: "customer_id"
          description: "Unique customer identifier"
        - name: "full_name"
          description: "Customer full name"
          expr: "FIRST_NAME || ' ' || LAST_NAME"
        - name: "age_group"
          description: "Customer age category based on birth date"
          expr: "CASE 
                   WHEN DATEDIFF('year', DATE_OF_BIRTH, CURRENT_DATE()) < 30 THEN 'Under 30'
                   WHEN DATEDIFF('year', DATE_OF_BIRTH, CURRENT_DATE()) < 40 THEN '30-39'
                   WHEN DATEDIFF('year', DATE_OF_BIRTH, CURRENT_DATE()) < 50 THEN '40-49'
                   WHEN DATEDIFF('year', DATE_OF_BIRTH, CURRENT_DATE()) < 60 THEN '50-59'
                   ELSE '60+' 
                 END"
        - name: "income_bracket"
          description: "Customer income level category for market segmentation"
          expr: "CASE 
                   WHEN ANNUAL_INCOME < 50000 THEN 'Under $50K'
                   WHEN ANNUAL_INCOME < 75000 THEN '$50K-$75K'
                   WHEN ANNUAL_INCOME < 100000 THEN '$75K-$100K'
                   WHEN ANNUAL_INCOME < 150000 THEN '$100K-$150K'
                   WHEN ANNUAL_INCOME < 200000 THEN '$150K-$200K'
                   ELSE '$200K+' 
                 END"
        - name: "credit_rating"
          description: "Customer credit score category for risk assessment"
          expr: "CASE 
                   WHEN CREDIT_SCORE < 600 THEN 'Poor (Under 600)'
                   WHEN CREDIT_SCORE < 650 THEN 'Fair (600-649)'
                   WHEN CREDIT_SCORE < 700 THEN 'Good (650-699)'
                   WHEN CREDIT_SCORE < 750 THEN 'Very Good (700-749)'
                   WHEN CREDIT_SCORE < 800 THEN 'Excellent (750-799)'
                   ELSE 'Exceptional (800+)' 
                 END"
        - name: "marital_status"
          description: "Customer marital status"
        - name: "employment_status"
          description: "Customer employment type and stability"
        - name: "family_size"
          description: "Number of family members affecting housing needs"
        - name: "customer_tenure"
          description: "How long customer has been in our system"
          expr: "DATEDIFF('month', CUSTOMER_SINCE, CURRENT_DATE())"

    # Property dimensions
    - name: "property_details"
      description: "Property characteristics, features, and location attributes"
      table: "house_characteristics"
      columns:
        - name: "house_id"
          description: "Unique property identifier"
        - name: "full_address"
          description: "Complete property address"
          expr: "ADDRESS || ', ' || CITY || ', ' || STATE || ' ' || ZIP_CODE"
        - name: "location"
          description: "Geographic location details"
        - name: "state"
          description: "State where property is located"
        - name: "city"
          description: "City where property is located"
        - name: "neighborhood"
          description: "Specific neighborhood or district"
        - name: "property_type"
          description: "Type of property (Single Family, Condo, Townhouse)"
        - name: "size_category"
          description: "Property size classification based on square footage"
          expr: "CASE 
                   WHEN SQUARE_FOOTAGE < 1000 THEN 'Compact (Under 1,000 sq ft)'
                   WHEN SQUARE_FOOTAGE < 1500 THEN 'Small (1,000-1,499 sq ft)'
                   WHEN SQUARE_FOOTAGE < 2000 THEN 'Medium (1,500-1,999 sq ft)'
                   WHEN SQUARE_FOOTAGE < 2500 THEN 'Large (2,000-2,499 sq ft)'
                   WHEN SQUARE_FOOTAGE < 3500 THEN 'Very Large (2,500-3,499 sq ft)'
                   ELSE 'Luxury (3,500+ sq ft)' 
                 END"
        - name: "bedrooms"
          description: "Number of bedrooms"
        - name: "bathrooms"
          description: "Number of bathrooms"
        - name: "year_built"
          description: "Year the property was constructed"
        - name: "age_category"
          description: "Property age classification for market analysis"
          expr: "CASE 
                   WHEN YEAR_BUILT >= 2020 THEN 'New Construction (2020+)'
                   WHEN YEAR_BUILT >= 2010 THEN 'Recent (2010-2019)'
                   WHEN YEAR_BUILT >= 2000 THEN 'Modern (2000-2009)'
                   WHEN YEAR_BUILT >= 1990 THEN 'Established (1990-1999)'
                   WHEN YEAR_BUILT >= 1980 THEN 'Mature (1980-1989)'
                   ELSE 'Vintage (Pre-1980)' 
                 END"
        - name: "premium_features"
          description: "Property has premium amenities and features"
          expr: "CASE WHEN (HAS_POOL = TRUE OR HAS_FIREPLACE = TRUE OR GARAGE_SPACES >= 3 OR HAS_BASEMENT = TRUE) THEN 'Premium Features' ELSE 'Standard Features' END"
        - name: "garage_category"
          description: "Garage capacity classification"
          expr: "CASE 
                   WHEN GARAGE_SPACES = 0 THEN 'No Garage'
                   WHEN GARAGE_SPACES = 1 THEN 'Single Car'
                   WHEN GARAGE_SPACES = 2 THEN 'Two Car'
                   ELSE 'Multi-Car (3+)'
                 END"

    # Geographic and lifestyle dimensions
    - name: "location_metrics"
      description: "Location-based property metrics and lifestyle indicators"
      table: "house_characteristics"
      columns:
        - name: "walk_score_category"
          description: "Walkability rating category for urban planning analysis"
          expr: "CASE 
                   WHEN WALK_SCORE >= 90 THEN 'Walker\\'s Paradise (90-100)'
                   WHEN WALK_SCORE >= 70 THEN 'Very Walkable (70-89)'
                   WHEN WALK_SCORE >= 50 THEN 'Somewhat Walkable (50-69)'
                   WHEN WALK_SCORE >= 25 THEN 'Car-Dependent (25-49)'
                   ELSE 'Car Required (0-24)' 
                 END"
        - name: "crime_rate"
          description: "Area safety and crime level"
        - name: "school_district"
          description: "School district serving the property"
        - name: "regional_market"
          description: "Regional market classification for comparative analysis"
          expr: "CASE 
                   WHEN STATE = 'CA' AND CITY IN ('San Jose', 'Palo Alto', 'Mountain View') THEN 'Silicon Valley'
                   WHEN STATE = 'CA' AND CITY IN ('San Francisco', 'Oakland') THEN 'Bay Area'
                   WHEN STATE = 'CA' AND CITY IN ('Los Angeles', 'Beverly Hills', 'West Hollywood') THEN 'Greater LA'
                   WHEN STATE = 'CA' THEN 'California Other'
                   WHEN STATE = 'TX' AND CITY = 'Austin' THEN 'Austin Metro'
                   WHEN STATE = 'TX' AND CITY IN ('Round Rock', 'Pflugerville', 'Cedar Park', 'Leander', 'Georgetown') THEN 'Austin Suburbs'
                   WHEN STATE = 'TX' AND CITY = 'Houston' THEN 'Houston Metro'
                   WHEN STATE = 'TX' THEN 'Texas Other'
                   WHEN STATE = 'FL' AND CITY IN ('Miami', 'Miami Beach', 'Fort Lauderdale', 'Key Biscayne', 'Coral Gables') THEN 'South Florida'
                   WHEN STATE = 'FL' THEN 'Florida Other'
                   WHEN STATE = 'CO' AND CITY IN ('Denver', 'Aurora') THEN 'Denver Metro'
                   WHEN STATE = 'CO' AND CITY IN ('Vail', 'Steamboat Springs') THEN 'Colorado Ski'
                   WHEN STATE = 'CO' THEN 'Colorado Other'
                   WHEN STATE = 'AZ' AND CITY IN ('Phoenix', 'Scottsdale', 'Tempe', 'Chandler') THEN 'Phoenix Metro'
                   WHEN STATE = 'AZ' THEN 'Arizona Other'
                   ELSE 'Other Markets'
                 END"

    # Time and market timing dimensions
    - name: "time_periods"
      description: "Time-based analysis dimensions for market trends"
      table: "house_sales"
      columns:
        - name: "sale_year"
          description: "Year of sale transaction"
          expr: "YEAR(SALE_DATE)"
        - name: "sale_month"
          description: "Month of sale transaction"
          expr: "MONTH(SALE_DATE)"
        - name: "sale_quarter"
          description: "Quarter of sale transaction"
          expr: "QUARTER(SALE_DATE)"
        - name: "sale_month_name"
          description: "Month name for seasonal analysis"
          expr: "MONTHNAME(SALE_DATE)"
        - name: "sale_season"
          description: "Season when sale occurred"
          expr: "CASE 
                   WHEN MONTH(SALE_DATE) IN (12, 1, 2) THEN 'Winter'
                   WHEN MONTH(SALE_DATE) IN (3, 4, 5) THEN 'Spring'
                   WHEN MONTH(SALE_DATE) IN (6, 7, 8) THEN 'Summer'
                   ELSE 'Fall'
                 END"
        - name: "market_timing"
          description: "How quickly property sold relative to market conditions"
          expr: "CASE 
                   WHEN DAYS_ON_MARKET <= 14 THEN 'Very Fast (â‰¤2 weeks)'
                   WHEN DAYS_ON_MARKET <= 30 THEN 'Fast (2-4 weeks)'
                   WHEN DAYS_ON_MARKET <= 60 THEN 'Normal (1-2 months)'
                   WHEN DAYS_ON_MARKET <= 90 THEN 'Slow (2-3 months)'
                   ELSE 'Very Slow (3+ months)' 
                 END"
        - name: "interest_rate_environment"
          description: "Interest rate market conditions at time of sale"
          expr: "CASE 
                   WHEN INTEREST_RATE < 4.0 THEN 'Low Rates (Under 4%)'
                   WHEN INTEREST_RATE < 5.0 THEN 'Moderate Rates (4-5%)'
                   WHEN INTEREST_RATE < 6.0 THEN 'Elevated Rates (5-6%)'
                   WHEN INTEREST_RATE < 7.0 THEN 'High Rates (6-7%)'
                   ELSE 'Very High Rates (7%+)'
                 END"

    # Financial and transaction dimensions
    - name: "financial_attributes"
      description: "Financial aspects of transactions and pricing"
      table: "house_sales"
      columns:
        - name: "financing_type"
          description: "Type of financing used for purchase"
        - name: "payment_method"
          description: "Cash vs financed purchase classification"
          expr: "CASE WHEN FINANCING_TYPE = 'Cash' THEN 'Cash Purchase' ELSE 'Financed Purchase' END"
        - name: "price_range"
          description: "Sale price range for market segmentation"
          expr: "CASE 
                   WHEN SALE_PRICE < 300000 THEN 'Under $300K'
                   WHEN SALE_PRICE < 500000 THEN '$300K-$500K'
                   WHEN SALE_PRICE < 750000 THEN '$500K-$750K'
                   WHEN SALE_PRICE < 1000000 THEN '$750K-$1M'
                   WHEN SALE_PRICE < 1500000 THEN '$1M-$1.5M'
                   ELSE '$1.5M+' 
                 END"
        - name: "down_payment_category"
          description: "Down payment percentage category"
          expr: "CASE 
                   WHEN FINANCING_TYPE = 'Cash' THEN 'Cash Purchase'
                   WHEN (DOWN_PAYMENT_AMOUNT / SALE_PRICE) < 0.05 THEN 'Low Down (Under 5%)'
                   WHEN (DOWN_PAYMENT_AMOUNT / SALE_PRICE) < 0.10 THEN 'Standard Down (5-10%)'
                   WHEN (DOWN_PAYMENT_AMOUNT / SALE_PRICE) < 0.20 THEN 'Moderate Down (10-20%)'
                   ELSE 'High Down (20%+)'
                 END"
        - name: "loan_to_value_category"
          description: "Loan-to-value ratio classification"
          expr: "CASE 
                   WHEN FINANCING_TYPE = 'Cash' THEN 'No Financing'
                   WHEN (LOAN_AMOUNT / SALE_PRICE) > 0.95 THEN 'High LTV (95%+)'
                   WHEN (LOAN_AMOUNT / SALE_PRICE) > 0.80 THEN 'Standard LTV (80-95%)'
                   ELSE 'Low LTV (Under 80%)'
                 END"

  # Define measures for analysis
  measures:
    # Price and value measures
    - name: "average_sale_price"
      description: "Average sale price of properties"
      agg: "AVG"
      expr: "house_sales.SALE_PRICE"
      
    - name: "median_sale_price"
      description: "Median sale price of properties"
      agg: "MEDIAN"
      expr: "house_sales.SALE_PRICE"
      
    - name: "total_sales_volume"
      description: "Total dollar volume of sales transactions"
      agg: "SUM"
      expr: "house_sales.SALE_PRICE"
      
    - name: "price_per_sqft"
      description: "Average price per square foot"
      agg: "AVG"
      expr: "house_sales.SALE_PRICE / house_characteristics.SQUARE_FOOTAGE"
      
    - name: "average_listing_price"
      description: "Average listing price of properties"
      agg: "AVG"
      expr: "house_characteristics.LISTING_PRICE"
      
    # Market timing and performance measures
    - name: "average_days_on_market"
      description: "Average number of days properties stayed on market"
      agg: "AVG"
      expr: "house_sales.DAYS_ON_MARKET"
      
    - name: "price_reduction_percentage"
      description: "Average percentage reduction from listing to sale price"
      agg: "AVG"
      expr: "(house_sales.LISTING_PRICE - house_sales.SALE_PRICE) / house_sales.LISTING_PRICE * 100"
      
    - name: "sale_to_list_ratio"
      description: "Ratio of sale price to listing price"
      agg: "AVG"
      expr: "house_sales.SALE_PRICE / house_sales.LISTING_PRICE"
      
    # Count and volume measures
    - name: "number_of_sales"
      description: "Total number of property sales transactions"
      agg: "COUNT"
      expr: "house_sales.SALE_ID"
      
    - name: "number_of_customers"
      description: "Total number of unique customers"
      agg: "COUNT_DISTINCT"
      expr: "house_sales.CUSTOMER_ID"
      
    - name: "number_of_properties"
      description: "Total number of unique properties"
      agg: "COUNT_DISTINCT"
      expr: "house_sales.HOUSE_ID"
      
    # Financial and lending measures
    - name: "average_loan_amount"
      description: "Average loan amount for financed purchases"
      agg: "AVG"
      expr: "house_sales.LOAN_AMOUNT"
      
    - name: "average_down_payment"
      description: "Average down payment amount"
      agg: "AVG"
      expr: "house_sales.DOWN_PAYMENT_AMOUNT"
      
    - name: "average_interest_rate"
      description: "Average interest rate for financed purchases"
      agg: "AVG"
      expr: "house_sales.INTEREST_RATE"
      
    - name: "total_commission"
      description: "Total commission paid to agents"
      agg: "SUM"
      expr: "house_sales.COMMISSION_AMOUNT"
      
    - name: "average_commission_rate"
      description: "Average commission rate charged"
      agg: "AVG"
      expr: "house_sales.COMMISSION_RATE"
      
    # Customer financial measures
    - name: "average_customer_income"
      description: "Average annual income of customers"
      agg: "AVG"
      expr: "customers.ANNUAL_INCOME"
      
    - name: "average_credit_score"
      description: "Average credit score of customers"
      agg: "AVG"
      expr: "customers.CREDIT_SCORE"
      
    # Property characteristic measures
    - name: "average_square_footage"
      description: "Average square footage of properties"
      agg: "AVG"
      expr: "house_characteristics.SQUARE_FOOTAGE"
      
    - name: "average_lot_size"
      description: "Average lot size in square feet"
      agg: "AVG"
      expr: "house_characteristics.LOT_SIZE_SQFT"
      
    - name: "average_walk_score"
      description: "Average walkability score"
      agg: "AVG"
      expr: "house_characteristics.WALK_SCORE"

  # Define filters for common queries
  filters:
    - name: "sale_date_range"
      description: "Filter sales by date range for temporal analysis"
      expr: "house_sales.SALE_DATE"
      
    - name: "price_range_filter"
      description: "Filter properties by sale price range"
      expr: "house_sales.SALE_PRICE"
      
    - name: "location_filter"
      description: "Filter by geographic location (city, state, region)"
      expr: "house_characteristics.CITY"
      
    - name: "state_filter"
      description: "Filter by state"
      expr: "house_characteristics.STATE"
      
    - name: "property_type_filter"
      description: "Filter by property type"
      expr: "house_characteristics.PROPERTY_TYPE"
      
    - name: "financing_type_filter"
      description: "Filter by financing method"
      expr: "house_sales.FINANCING_TYPE"
      
    - name: "customer_income_filter"
      description: "Filter by customer income range"
      expr: "customers.ANNUAL_INCOME"
      
    - name: "credit_score_filter"
      description: "Filter by customer credit score range"
      expr: "customers.CREDIT_SCORE"
      
    - name: "agent_filter"
      description: "Filter by real estate agent"
      expr: "house_sales.AGENT_NAME"
      
    - name: "square_footage_filter"
      description: "Filter by property size"
      expr: "house_characteristics.SQUARE_FOOTAGE"